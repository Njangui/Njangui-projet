import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { motion, AnimatePresence } from "framer-motion";
import { Helmet } from "react-helmet-async";
import { z } from "zod";
import { toast } from "sonner";
import { ArrowLeft, ArrowRight, Home, MapPin, Camera, FileText, Eye, Sparkles, Loader2, MessageCircle } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Checkbox } from "@/components/ui/checkbox";
import { Switch } from "@/components/ui/switch";
import Navbar from "@/components/Navbar";
import Footer from "@/components/Footer";
import PropertyImageUpload from "@/components/PropertyImageUpload";
import PropertyLocationPicker from "@/components/PropertyLocationPicker";
import PropertyPreview from "@/components/PropertyPreview";
import NumberStepper from "@/components/NumberStepper";
import { useAuth } from "@/contexts/AuthContext";
import { useLanguage } from "@/contexts/LanguageContext";
import { supabase } from "@/integrations/supabase/client";

const listingSchema = z.object({
  title: z.string().min(10, "Le titre doit contenir au moins 10 caract√®res").max(100),
  description: z.string().min(50, "La description doit contenir au moins 50 caract√®res").max(2000),
  property_type: z.enum(["studio", "apartment", "house", "room", "villa"]),
  listing_type: z.enum(["rent", "sale", "colocation", "short_term"]),
  price: z.number().min(1000, "Le prix doit √™tre sup√©rieur √† 1000 FCFA"),
  price_unit: z.enum(["month", "day", "sale"]),
  deposit: z.number().nullable(),
  bedrooms: z.number().min(0).max(20),
  bathrooms: z.number().min(0).max(10),
  area: z.number().nullable(),
  city: z.string().min(1, "Veuillez s√©lectionner une ville"),
  neighborhood: z.string(),
  address: z.string().min(5, "L'adresse est obligatoire (min. 5 caract√®res)"),
  latitude: z.number().nullable(),
  longitude: z.number().nullable(),
  amenities: z.array(z.string()),
  images: z.array(z.string()).min(1, "Ajoutez au moins une photo"),
  whatsapp_enabled: z.boolean(),
  whatsapp_number: z.string().nullable(),
});

type ListingData = z.infer<typeof listingSchema>;

const CreateListing = () => {
  const { user } = useAuth();
  const navigate = useNavigate();
  const { t, language } = useLanguage();
  const [step, setStep] = useState(1);
  const [showPreview, setShowPreview] = useState(false);
  const [isPublishing, setIsPublishing] = useState(false);
  const [isGeneratingDescription, setIsGeneratingDescription] = useState(false);
  const [errors, setErrors] = useState<Record<string, string>>({});

  const STEPS = [
    { id: 1, label: t("createListing.step1"), icon: Home },
    { id: 2, label: t("createListing.step2"), icon: MapPin },
    { id: 3, label: t("createListing.step3"), icon: Camera },
    { id: 4, label: t("createListing.step4"), icon: FileText },
    { id: 5, label: t("createListing.step5"), icon: Eye },
  ];

  const PROPERTY_TYPES = [
    { value: "studio", label: t("property.studio"), icon: "üè¢" },
    { value: "apartment", label: t("property.apartment"), icon: "üè†" },
    { value: "house", label: t("property.house"), icon: "üè°" },
    { value: "room", label: t("property.room"), icon: "üõèÔ∏è" },
    { value: "villa", label: t("property.villa"), icon: "üè∞" },
  ];

  const LISTING_TYPES = [
    { value: "rent", label: t("listing.rent"), description: language === "fr" ? "Location mensuelle" : "Monthly rent" },
    { value: "sale", label: t("listing.sale"), description: language === "fr" ? "Vente immobili√®re" : "Real estate sale" },
    { value: "colocation", label: t("listing.colocation"), description: language === "fr" ? "Partage de logement" : "Shared housing" },
    { value: "short_term", label: t("listing.shortTerm"), description: language === "fr" ? "Location journali√®re" : "Daily rental" },
  ];

  const AMENITIES = [
    { value: "wifi", label: t("amenity.wifi") },
    { value: "parking", label: t("amenity.parking") },
    { value: "pool", label: t("amenity.pool") },
    { value: "gym", label: t("amenity.gym") },
    { value: "security", label: t("amenity.security") },
    { value: "generator", label: t("amenity.generator") },
    { value: "water_tank", label: t("amenity.waterTank") },
    { value: "furnished", label: t("amenity.furnished") },
    { value: "air_conditioning", label: t("amenity.airConditioning") },
    { value: "garden", label: t("amenity.garden") },
    { value: "balcony", label: t("amenity.balcony") },
    { value: "terrace", label: t("amenity.terrace") },
  ];

  const [formData, setFormData] = useState<ListingData>({
    title: "",
    description: "",
    property_type: "apartment",
    listing_type: "rent",
    price: 0,
    price_unit: "month",
    deposit: null,
    bedrooms: 1,
    bathrooms: 1,
    area: null,
    city: "",
    neighborhood: "",
    address: "",
    latitude: null,
    longitude: null,
    amenities: [],
    images: [],
    whatsapp_enabled: false,
    whatsapp_number: null,
  });

  if (!user) {
    return (
      <div className="min-h-screen bg-background">
        <Navbar />
        <div className="container mx-auto px-4 py-20 text-center">
          <h1 className="text-2xl font-bold text-foreground mb-4">{t("createListing.loginRequired")}</h1>
          <p className="text-muted-foreground mb-6">
            {t("createListing.loginMessage")}
          </p>
          <Button onClick={() => navigate("/auth")}>{t("common.login")}</Button>
        </div>
        <Footer />
      </div>
    );
  }

  const updateFormData = (updates: Partial<ListingData>) => {
    setFormData((prev) => ({ ...prev, ...updates }));
    const keys = Object.keys(updates);
    setErrors((prev) => {
      const newErrors = { ...prev };
      keys.forEach((key) => delete newErrors[key]);
      return newErrors;
    });
  };

  const validateStep = () => {
    const newErrors: Record<string, string> = {};

    switch (step) {
      case 1:
        if (!formData.property_type) newErrors.property_type = language === "fr" ? "S√©lectionnez un type de bien" : "Select a property type";
        if (!formData.listing_type) newErrors.listing_type = language === "fr" ? "S√©lectionnez un type d'annonce" : "Select a listing type";
        break;
      case 2:
        if (!formData.city) newErrors.city = language === "fr" ? "S√©lectionnez une ville" : "Select a city";
        if (!formData.address || formData.address.length < 5) newErrors.address = t("createListing.addressRequired");
        break;
      case 3:
        if (formData.images.length === 0) newErrors.images = language === "fr" ? "Ajoutez au moins une photo" : "Add at least one photo";
        break;
      case 4:
        if (formData.title.length < 10) newErrors.title = language === "fr" ? "Le titre doit contenir au moins 10 caract√®res" : "Title must be at least 10 characters";
        if (formData.description.length < 50) newErrors.description = language === "fr" ? "La description doit contenir au moins 50 caract√®res" : "Description must be at least 50 characters";
        if (formData.price < 1000) newErrors.price = language === "fr" ? "Le prix doit √™tre sup√©rieur √† 1000 FCFA" : "Price must be greater than 1000 FCFA";
        break;
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleNext = () => {
    if (validateStep()) {
      if (step === 4) {
        setShowPreview(true);
      } else {
        setStep((prev) => Math.min(prev + 1, 5));
      }
    }
  };

  const handleBack = () => {
    setStep((prev) => Math.max(prev - 1, 1));
  };

  const handlePublish = async () => {
    try {
      const validated = listingSchema.parse(formData);
      setIsPublishing(true);

      const { error } = await supabase.from("properties").insert({
        owner_id: user.id,
        title: validated.title,
        description: validated.description,
        property_type: validated.property_type,
        listing_type: validated.listing_type,
        price: validated.price,
        price_unit: validated.price_unit,
        deposit: validated.deposit,
        bedrooms: validated.bedrooms,
        bathrooms: validated.bathrooms,
        area: validated.area,
        city: validated.city,
        neighborhood: validated.neighborhood,
        address: validated.address,
        latitude: validated.latitude,
        longitude: validated.longitude,
        amenities: validated.amenities,
        images: validated.images,
        is_published: true,
        is_available: true,
        whatsapp_enabled: validated.whatsapp_enabled,
      });

      if (error) {
        console.error("Supabase error:", error);
        throw new Error(error.message);
      }

      toast.success(t("createListing.success"));
      navigate("/");
    } catch (error) {
      console.error("Publish error:", error);
      if (error instanceof z.ZodError) {
        const messages = error.errors.map(e => e.message).join(", ");
        toast.error(messages);
      } else if (error instanceof Error) {
        toast.error(error.message || (language === "fr" ? "Erreur lors de la publication de l'annonce." : "Error publishing listing."));
      } else {
        toast.error(language === "fr" ? "Erreur lors de la publication de l'annonce." : "Error publishing listing.");
      }
    } finally {
      setIsPublishing(false);
    }
  };

  const toggleAmenity = (value: string) => {
    const current = formData.amenities;
    const updated = current.includes(value)
      ? current.filter((a) => a !== value)
      : [...current, value];
    updateFormData({ amenities: updated });
  };

  const generateAIDescription = async () => {
    if (!formData.property_type || !formData.city) {
      toast.error(language === "fr" ? "Veuillez d'abord renseigner le type de bien et la ville." : "Please first fill in the property type and city.");
      return;
    }

    setIsGeneratingDescription(true);
    
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        toast.error(language === "fr" ? "Veuillez vous connecter pour utiliser cette fonctionnalit√©." : "Please login to use this feature.");
        return;
      }

      const propertyTypeLabels: Record<string, string> = {
        studio: "Studio",
        apartment: language === "fr" ? "Appartement" : "Apartment",
        house: language === "fr" ? "Maison" : "House",
        room: language === "fr" ? "Chambre" : "Room",
        villa: "Villa",
      };

      const listingTypeLabels: Record<string, string> = {
        rent: language === "fr" ? "location" : "rental",
        sale: language === "fr" ? "vente" : "sale",
        colocation: "colocation",
        short_term: language === "fr" ? "location courte dur√©e" : "short-term rental",
      };

      const prompt = language === "fr" 
        ? `G√©n√®re une description attrayante et professionnelle pour une annonce immobili√®re avec les caract√©ristiques suivantes:
- Type: ${propertyTypeLabels[formData.property_type] || formData.property_type}
- Objectif: ${listingTypeLabels[formData.listing_type] || formData.listing_type}
- Ville: ${formData.city}
- Quartier: ${formData.neighborhood || "Non pr√©cis√©"}
- Chambres: ${formData.bedrooms}
- Salles de bain: ${formData.bathrooms}
- Surface: ${formData.area ? formData.area + " m¬≤" : "Non pr√©cis√©e"}
- Prix: ${formData.price ? formData.price.toLocaleString() + " FCFA" : "Non pr√©cis√©"}
- √âquipements: ${formData.amenities.length > 0 ? formData.amenities.join(", ") : "Non pr√©cis√©s"}

La description doit √™tre en fran√ßais, professionnelle, attrayante, et faire environ 100-150 mots. Mets en avant les points forts du bien.`
        : `Generate an attractive and professional description for a real estate listing with the following features:
- Type: ${propertyTypeLabels[formData.property_type] || formData.property_type}
- Purpose: ${listingTypeLabels[formData.listing_type] || formData.listing_type}
- City: ${formData.city}
- Neighborhood: ${formData.neighborhood || "Not specified"}
- Bedrooms: ${formData.bedrooms}
- Bathrooms: ${formData.bathrooms}
- Area: ${formData.area ? formData.area + " sqm" : "Not specified"}
- Price: ${formData.price ? formData.price.toLocaleString() + " FCFA" : "Not specified"}
- Amenities: ${formData.amenities.length > 0 ? formData.amenities.join(", ") : "Not specified"}

The description should be in English, professional, attractive, and about 100-150 words. Highlight the property's strengths.`;

      const resp = await fetch(
        `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/property-ai-search`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${session.access_token}`,
            apikey: import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY,
          },
          body: JSON.stringify({
            messages: [{ role: "user", content: prompt }],
          }),
        }
      );

      if (!resp.ok) {
        throw new Error(language === "fr" ? "Erreur lors de la g√©n√©ration" : "Generation error");
      }

      const reader = resp.body?.getReader();
      const decoder = new TextDecoder();
      let fullResponse = "";

      if (reader) {
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split("\n");

          for (const line of lines) {
            if (line.startsWith("data: ") && !line.includes("[DONE]")) {
              try {
                const json = JSON.parse(line.slice(6));
                const content = json.choices?.[0]?.delta?.content;
                if (content) fullResponse += content;
              } catch {
                // Ignore parse errors
              }
            }
          }
        }
      }

      const cleanedResponse = fullResponse
        .replace(/```properties[\s\S]*?```/g, "")
        .trim();

      if (cleanedResponse) {
        updateFormData({ description: cleanedResponse });
        toast.success(t("toast.descriptionGenerated"));
      }
    } catch (error) {
      console.error("AI error:", error);
      toast.error(language === "fr" ? "Erreur lors de la g√©n√©ration de la description." : "Error generating description.");
    } finally {
      setIsGeneratingDescription(false);
    }
  };

  return (
    <div className="min-h-screen bg-background">
      <Helmet>
        <title>{t("createListing.title")} - Njangui</title>
        <meta name="description" content={language === "fr" ? "Publiez votre annonce immobili√®re sur Njangui" : "Publish your real estate listing on Njangui"} />
      </Helmet>

      <Navbar />

      <main className="container mx-auto px-4 py-8 pb-32">
        {/* Progress */}
        <div className="max-w-3xl mx-auto mb-8">
          <div className="flex items-center justify-between">
            {STEPS.map((s, i) => (
              <div key={s.id} className="flex items-center">
                <div
                  className={`flex items-center gap-2 px-4 py-2 rounded-full transition-colors ${
                    step >= s.id
                      ? "bg-primary text-primary-foreground"
                      : "bg-secondary text-muted-foreground"
                  }`}
                >
                  <s.icon className="w-4 h-4" />
                  <span className="hidden sm:inline text-sm font-medium">{s.label}</span>
                </div>
                {i < STEPS.length - 1 && (
                  <div
                    className={`w-8 sm:w-16 h-0.5 mx-2 ${
                      step > s.id ? "bg-primary" : "bg-border"
                    }`}
                  />
                )}
              </div>
            ))}
          </div>
        </div>

        {/* Form Content */}
        <div className="max-w-3xl mx-auto">
          <AnimatePresence mode="wait">
            {/* Step 1: Property Type */}
            {step === 1 && (
              <motion.div
                key="step1"
                initial={{ opacity: 0, x: 20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -20 }}
                className="space-y-8"
              >
                <div>
                  <h2 className="text-2xl font-bold text-foreground mb-2">{t("createListing.propertyType")}</h2>
                  <p className="text-muted-foreground">{t("createListing.whatType")}</p>
                </div>

                <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                  {PROPERTY_TYPES.map((type) => (
                    <button
                      key={type.value}
                      type="button"
                      onClick={() => updateFormData({ property_type: type.value as ListingData["property_type"] })}
                      className={`p-6 rounded-xl border-2 text-center transition-all ${
                        formData.property_type === type.value
                          ? "border-primary bg-primary/5"
                          : "border-border hover:border-primary/50"
                      }`}
                    >
                      <span className="text-3xl block mb-2">{type.icon}</span>
                      <span className="font-medium text-foreground">{type.label}</span>
                    </button>
                  ))}
                </div>

                <div>
                  <h3 className="text-lg font-semibold text-foreground mb-4">{t("createListing.listingType")}</h3>
                  <div className="grid grid-cols-2 gap-4">
                    {LISTING_TYPES.map((type) => (
                      <button
                        key={type.value}
                        type="button"
                        onClick={() => {
                          updateFormData({
                            listing_type: type.value as ListingData["listing_type"],
                            price_unit: type.value === "sale" ? "sale" : type.value === "short_term" ? "day" : "month",
                          });
                        }}
                        className={`p-4 rounded-xl border-2 text-left transition-all ${
                          formData.listing_type === type.value
                            ? "border-primary bg-primary/5"
                            : "border-border hover:border-primary/50"
                        }`}
                      >
                        <span className="font-medium text-foreground block">{type.label}</span>
                        <span className="text-sm text-muted-foreground">{type.description}</span>
                      </button>
                    ))}
                  </div>
                </div>
              </motion.div>
            )}

            {/* Step 2: Location */}
            {step === 2 && (
              <motion.div
                key="step2"
                initial={{ opacity: 0, x: 20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -20 }}
                className="space-y-6"
              >
                <div>
                  <h2 className="text-2xl font-bold text-foreground mb-2">{t("property.location")}</h2>
                  <p className="text-muted-foreground">{t("createListing.whereIs")}</p>
                </div>

                <PropertyLocationPicker
                  latitude={formData.latitude}
                  longitude={formData.longitude}
                  address={formData.address}
                  city={formData.city}
                  neighborhood={formData.neighborhood}
                  onLocationChange={(data) => updateFormData(data)}
                />

                {errors.city && <p className="text-sm text-destructive">{errors.city}</p>}
              </motion.div>
            )}

            {/* Step 3: Photos */}
            {step === 3 && (
              <motion.div
                key="step3"
                initial={{ opacity: 0, x: 20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -20 }}
                className="space-y-6"
              >
                <div>
                  <h2 className="text-2xl font-bold text-foreground mb-2">{t("createListing.step3")}</h2>
                  <p className="text-muted-foreground">{t("createListing.photosSubtitle")}</p>
                </div>

                <PropertyImageUpload
                  images={formData.images}
                  onChange={(images) => updateFormData({ images })}
                  userId={user.id}
                />

                {errors.images && <p className="text-sm text-destructive">{errors.images}</p>}
              </motion.div>
            )}

            {/* Step 4: Details */}
            {step === 4 && (
              <motion.div
                key="step4"
                initial={{ opacity: 0, x: 20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -20 }}
                className="space-y-6"
              >
                <div>
                  <h2 className="text-2xl font-bold text-foreground mb-2">{t("createListing.step4")}</h2>
                  <p className="text-muted-foreground">
                    {language === "fr" ? "D√©crivez votre bien en d√©tail" : "Describe your property in detail"}
                  </p>
                </div>

                <div className="space-y-4">
                  <div>
                    <label className="text-sm font-medium text-foreground mb-2 block">
                      {t("createListing.titleLabel")} *
                    </label>
                    <Input
                      value={formData.title}
                      onChange={(e) => updateFormData({ title: e.target.value })}
                      placeholder={t("createListing.titlePlaceholder")}
                      maxLength={100}
                    />
                    {errors.title && <p className="text-sm text-destructive mt-1">{errors.title}</p>}
                  </div>

                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <label className="text-sm font-medium text-foreground">
                        {t("createListing.descriptionLabel")} *
                      </label>
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={generateAIDescription}
                        disabled={isGeneratingDescription}
                        className="gap-2"
                      >
                        {isGeneratingDescription ? (
                          <Loader2 className="w-4 h-4 animate-spin" />
                        ) : (
                          <Sparkles className="w-4 h-4" />
                        )}
                        {t("createListing.generateAI")}
                      </Button>
                    </div>
                    <Textarea
                      value={formData.description}
                      onChange={(e) => updateFormData({ description: e.target.value })}
                      placeholder={language === "fr" 
                        ? "D√©crivez votre bien en d√©tail (caract√©ristiques, environnement, acc√®s...)" 
                        : "Describe your property in detail (features, environment, access...)"}
                      rows={5}
                      maxLength={2000}
                    />
                    <p className="text-xs text-muted-foreground mt-1">
                      {formData.description.length}/2000 {language === "fr" ? "caract√®res" : "characters"}
                    </p>
                    {errors.description && (
                      <p className="text-sm text-destructive">{errors.description}</p>
                    )}
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="text-sm font-medium text-foreground mb-2 block">
                        {t("createListing.priceLabel")} (FCFA) *
                      </label>
                      <Input
                        type="number"
                        value={formData.price || ""}
                        onChange={(e) => updateFormData({ price: parseInt(e.target.value) || 0 })}
                        placeholder="Ex: 150000"
                      />
                      {errors.price && <p className="text-sm text-destructive mt-1">{errors.price}</p>}
                    </div>
                    <div>
                      <label className="text-sm font-medium text-foreground mb-2 block">
                        {t("createListing.depositLabel")} (FCFA)
                      </label>
                      <Input
                        type="number"
                        value={formData.deposit || ""}
                        onChange={(e) =>
                          updateFormData({ deposit: parseInt(e.target.value) || null })
                        }
                        placeholder="Ex: 300000"
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div>
                      <label className="text-sm font-medium text-foreground mb-3 block">
                        {t("createListing.bedroomsLabel")}
                      </label>
                      <NumberStepper
                        value={formData.bedrooms}
                        onChange={(val) => updateFormData({ bedrooms: val })}
                        min={0}
                        max={20}
                      />
                    </div>
                    <div>
                      <label className="text-sm font-medium text-foreground mb-3 block">
                        {t("createListing.bathroomsLabel")}
                      </label>
                      <NumberStepper
                        value={formData.bathrooms}
                        onChange={(val) => updateFormData({ bathrooms: val })}
                        min={0}
                        max={10}
                      />
                    </div>
                    <div>
                      <label className="text-sm font-medium text-foreground mb-2 block">
                        {t("createListing.areaLabel")}
                      </label>
                      <Input
                        type="number"
                        inputMode="numeric"
                        value={formData.area || ""}
                        onChange={(e) => updateFormData({ area: parseInt(e.target.value) || null })}
                        placeholder="Ex: 80"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="text-sm font-medium text-foreground mb-3 block">
                      {t("createListing.amenitiesLabel")}
                    </label>
                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                      {AMENITIES.map((amenity) => (
                        <div
                          key={amenity.value}
                          className="flex items-center space-x-2"
                        >
                          <Checkbox
                            id={amenity.value}
                            checked={formData.amenities.includes(amenity.value)}
                            onCheckedChange={() => toggleAmenity(amenity.value)}
                          />
                          <label
                            htmlFor={amenity.value}
                            className="text-sm text-foreground cursor-pointer"
                          >
                            {amenity.label}
                          </label>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* WhatsApp Contact Option */}
                  <div className="p-4 rounded-xl border-2 border-border bg-card/50">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-full bg-[#25D366]/20 flex items-center justify-center">
                          <MessageCircle className="w-5 h-5 text-[#25D366]" />
                        </div>
                        <div>
                          <p className="font-medium text-foreground">
                            {language === "fr" ? "Activer WhatsApp" : "Enable WhatsApp"}
                          </p>
                          <p className="text-sm text-muted-foreground">
                            {language === "fr" 
                              ? "Permettre aux visiteurs de vous contacter via WhatsApp"
                              : "Allow visitors to contact you via WhatsApp"
                            }
                          </p>
                        </div>
                      </div>
                      <Switch
                        checked={formData.whatsapp_enabled}
                        onCheckedChange={(checked) => updateFormData({ whatsapp_enabled: checked })}
                      />
                    </div>
                    
                    {formData.whatsapp_enabled && (
                      <div className="mt-4">
                        <label className="text-sm font-medium text-foreground mb-2 block">
                          {language === "fr" ? "Num√©ro WhatsApp (optionnel)" : "WhatsApp number (optional)"}
                        </label>
                        <Input
                          type="tel"
                          value={formData.whatsapp_number || ""}
                          onChange={(e) => updateFormData({ whatsapp_number: e.target.value || null })}
                          placeholder="+237 6XX XXX XXX"
                          className="max-w-xs"
                        />
                        <p className="text-xs text-muted-foreground mt-1">
                          {language === "fr" 
                            ? "Laissez vide pour utiliser le num√©ro de votre profil"
                            : "Leave empty to use your profile number"
                          }
                        </p>
                      </div>
                    )}
                  </div>
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </main>

      {/* Fixed Bottom Navigation */}
      <div className="fixed bottom-0 left-0 right-0 bg-card border-t border-border p-4">
        <div className="max-w-3xl mx-auto flex justify-between">
          <Button variant="outline" onClick={handleBack} disabled={step === 1}>
            <ArrowLeft className="w-4 h-4 mr-2" />
            {t("common.previous")}
          </Button>
          <Button variant="hero" onClick={handleNext}>
            {step === 4 ? (
              <>
                <Eye className="w-4 h-4 mr-2" />
                {t("createListing.step5")}
              </>
            ) : (
              <>
                {t("common.next")}
                <ArrowRight className="w-4 h-4 ml-2" />
              </>
            )}
          </Button>
        </div>
      </div>

      {/* Preview Modal */}
      <AnimatePresence>
        {showPreview && (
          <PropertyPreview
            data={formData as { title: string; description: string; property_type: string; listing_type: string; price: number; price_unit: string; deposit: number | null; bedrooms: number; bathrooms: number; area: number | null; city: string; neighborhood: string; address: string; amenities: string[]; images: string[] }}
            onClose={() => setShowPreview(false)}
            onPublish={handlePublish}
            isPublishing={isPublishing}
          />
        )}
      </AnimatePresence>

      <Footer />
    </div>
  );
};

export default CreateListing;
