import { useState, useEffect } from "react";
import { useParams, useNavigate, useLocation } from "react-router-dom";
import { motion } from "framer-motion";
import { Helmet } from "react-helmet-async";
import { supabase } from "@/integrations/supabase/client";
import { useAuth } from "@/contexts/AuthContext";
import { useLanguage } from "@/contexts/LanguageContext";
import { usePropertyView } from "@/hooks/usePropertyView";
import Navbar from "@/components/Navbar";
import PropertyGallery from "@/components/PropertyGallery";
import PropertyMap from "@/components/PropertyMap";
import PropertyAmenities from "@/components/PropertyAmenities";
import PropertyCalendar from "@/components/PropertyCalendar";
import PropertyContactForm from "@/components/PropertyContactForm";
import { ReportDialog } from "@/components/ReportDialog";
import { WhatsAppButton } from "@/components/WhatsAppButton";
import { BookingDialog } from "@/components/BookingDialog";
import { Button } from "@/components/ui/button";
import { useToast } from "@/hooks/use-toast";
import { 
  ArrowLeft, 
  Heart, 
  Share2, 
  MapPin, 
  Bed, 
  Bath, 
  Square,
  Star,
  Check,
  Home,
  User,
  Calendar,
  Shield,
  Loader2,
  AlertCircle,
  Flag
} from "lucide-react";

// Import demo images
import property1 from "@/assets/property-1.jpg";
import property2 from "@/assets/property-2.jpg";
import property3 from "@/assets/property-3.jpg";
import property4 from "@/assets/property-4.jpg";
import property5 from "@/assets/property-5.jpg";

// Types
interface Property {
  id: string;
  owner_id: string;
  title: string;
  description: string | null;
  property_type: string;
  listing_type: string;
  address: string | null;
  city: string;
  neighborhood: string | null;
  latitude: number | null;
  longitude: number | null;
  price: number;
  price_unit: string;
  deposit: number | null;
  bedrooms: number | null;
  bathrooms: number | null;
  area: number | null;
  floor_number: number | null;
  total_floors: number | null;
  amenities: string[] | null;
  rules: string[] | null;
  min_stay_days: number | null;
  images: string[] | null;
  available_from: string | null;
  available_to: string | null;
  is_available: boolean;
  is_verified: boolean;
  created_at: string;
}

interface OwnerProfile {
  full_name: string | null;
  avatar_url: string | null;
  is_verified: boolean;
  phone: string | null;
  whatsapp_number: string | null;
}

// Demo property for when no real data exists
const demoProperty: Property = {
  id: "demo",
  owner_id: "demo-owner",
  title: "Appartement moderne avec terrasse - Bastos",
  description: `Magnifique appartement de 3 chambres situé dans le quartier prisé de Bastos à Yaoundé. 
  
Cet appartement lumineux offre un cadre de vie exceptionnel avec ses finitions haut de gamme, sa cuisine entièrement équipée et sa grande terrasse avec vue panoramique sur la ville.

L'appartement comprend :
- Un grand salon lumineux avec accès terrasse
- Une cuisine américaine moderne entièrement équipée
- 3 chambres spacieuses dont une suite parentale
- 2 salles de bain modernes
- Un espace buanderie
- Un parking privé sécurisé

Le quartier de Bastos offre un environnement calme et sécurisé, proche des ambassades, restaurants et commerces.

Idéal pour les familles ou les professionnels expatriés recherchant le confort et la sécurité.`,
  property_type: "apartment",
  listing_type: "rent",
  address: "Rue des Ambassades, Bastos",
  city: "Yaoundé",
  neighborhood: "Bastos",
  latitude: 3.8680,
  longitude: 11.5021,
  price: 250000,
  price_unit: "month",
  deposit: 500000,
  bedrooms: 3,
  bathrooms: 2,
  area: 120,
  floor_number: 4,
  total_floors: 6,
  amenities: ["wifi", "parking", "security", "water", "electricity", "ac", "tv", "kitchen", "laundry", "garden"],
  rules: ["Pas d'animaux", "Non-fumeur", "Pas de fêtes"],
  min_stay_days: 30,
  images: [property1, property2, property3, property4, property5],
  available_from: new Date().toISOString().split('T')[0],
  available_to: null,
  is_available: true,
  is_verified: true,
  created_at: new Date().toISOString(),
};

const PropertyDetail = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const location = useLocation();
  const { user } = useAuth();
  const { t, language } = useLanguage();
  const { toast } = useToast();
  
  const [property, setProperty] = useState<Property | null>(null);
  const [owner, setOwner] = useState<OwnerProfile | null>(null);
  const [loading, setLoading] = useState(true);
  const [isFavorite, setIsFavorite] = useState(false);

  // Determine source from URL params or referrer
  const source = new URLSearchParams(location.search).get("source") as "search" | "recommendation" | "direct" | "assistant" || "direct";

  // Track property view
  usePropertyView({ 
    propertyId: id && id !== "demo" ? id : "", 
    source 
  });

  useEffect(() => {
    fetchProperty();
  }, [id]);

  const fetchProperty = async () => {
    setLoading(true);

    // If demo or no id, show demo property
    if (!id || id === "demo") {
      setProperty(demoProperty);
      setOwner({ full_name: "Jean-Pierre Kamga", avatar_url: null, is_verified: true, phone: "+237699999999", whatsapp_number: "+237699999999" });
      setLoading(false);
      return;
    }

    try {
      // Fetch property
      const { data: propertyData, error: propertyError } = await supabase
        .from("properties")
        .select("*")
        .eq("id", id)
        .maybeSingle();

      if (propertyError) throw propertyError;

      if (propertyData) {
        setProperty(propertyData as Property);

        // Fetch owner profile
        const { data: ownerData } = await supabase
          .from("profiles")
          .select("full_name, avatar_url, is_verified, phone, whatsapp_number")
          .eq("user_id", propertyData.owner_id)
          .maybeSingle();

        if (ownerData) {
          setOwner(ownerData);
        }

        // Check if favorited
        if (user) {
          const { data: favData } = await supabase
            .from("property_favorites")
            .select("id")
            .eq("property_id", id)
            .eq("user_id", user.id)
            .maybeSingle();
          
          setIsFavorite(!!favData);
        }
      } else {
        // No property found, show demo
        setProperty(demoProperty);
        setOwner({ full_name: "Jean-Pierre Kamga", avatar_url: null, is_verified: true, phone: "+237699999999", whatsapp_number: "+237699999999" });
      }
    } catch (error) {
      console.error("Error fetching property:", error);
      // Show demo on error
      setProperty(demoProperty);
      setOwner({ full_name: "Jean-Pierre Kamga", avatar_url: null, is_verified: true, phone: "+237699999999", whatsapp_number: "+237699999999" });
    } finally {
      setLoading(false);
    }
  };

  const toggleFavorite = async () => {
    if (!user) {
      toast({
        title: t("toast.loginRequired"),
        description: t("toast.loginToFavorite"),
      });
      return;
    }

    if (!property || property.id === "demo") return;

    try {
      if (isFavorite) {
        await supabase
          .from("property_favorites")
          .delete()
          .eq("property_id", property.id)
          .eq("user_id", user.id);
        setIsFavorite(false);
        toast({ title: t("toast.removedFromFavorites") });
      } else {
        await supabase
          .from("property_favorites")
          .insert({ property_id: property.id, user_id: user.id });
        setIsFavorite(true);
        toast({ title: t("toast.addedToFavorites") });
      }
    } catch (error) {
      toast({
        variant: "destructive",
        title: t("common.error"),
        description: t("error.generic"),
      });
    }
  };

  const handleShare = async () => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: property?.title,
          url: window.location.href,
        });
      } catch (e) {
        // User cancelled
      }
    } else {
      await navigator.clipboard.writeText(window.location.href);
      toast({ title: t("toast.linkCopied") });
    }
  };

  const getPropertyTypeLabel = (type: string) => {
    const labels: Record<string, Record<string, string>> = {
      studio: { fr: "Studio", en: "Studio" },
      apartment: { fr: "Appartement", en: "Apartment" },
      house: { fr: "Maison", en: "House" },
      room: { fr: "Chambre", en: "Room" },
      villa: { fr: "Villa", en: "Villa" },
    };
    return labels[type]?.[language] || type;
  };

  const getListingTypeLabel = (type: string) => {
    const labels: Record<string, Record<string, string>> = {
      rent: { fr: "Location", en: "Rent" },
      sale: { fr: "Vente", en: "Sale" },
      colocation: { fr: "Colocation", en: "Roommate" },
      short_term: { fr: "Courte durée", en: "Short stay" },
    };
    return labels[type]?.[language] || type;
  };

  const getPriceUnitLabel = (unit: string) => {
    const labels: Record<string, Record<string, string>> = {
      month: { fr: "mois", en: "month" },
      day: { fr: "jour", en: "day" },
    };
    return labels[unit]?.[language] || (language === "fr" ? "vente" : "sale");
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  if (!property) {
    return (
      <div className="min-h-screen bg-background">
        <Navbar />
        <main className="pt-24 pb-16">
          <div className="container mx-auto px-4 text-center">
            <AlertCircle className="w-16 h-16 text-muted-foreground mx-auto mb-4" />
            <h1 className="text-2xl font-bold mb-2">Annonce introuvable</h1>
            <p className="text-muted-foreground mb-6">Cette annonce n'existe pas ou a été supprimée.</p>
            <Button onClick={() => navigate("/")}>Retour à l'accueil</Button>
          </div>
        </main>
      </div>
    );
  }

  return (
    <>
      <Helmet>
        <title>{property.title} | Njangui</title>
        <meta name="description" content={property.description?.slice(0, 160) || `${property.title} - ${property.city}`} />
      </Helmet>

      <div className="min-h-screen bg-background">
        <Navbar />

        <main className="pt-20 pb-16">
          <div className="container mx-auto px-4">
            {/* Back & Actions */}
            <div className="flex items-center justify-between py-4">
              <button
                onClick={() => navigate(-1)}
                className="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
              >
                <ArrowLeft className="w-4 h-4" />
                <span>Retour</span>
              </button>

              <div className="flex items-center gap-2">
                <Button
                  variant="outline"
                  size="icon"
                  onClick={toggleFavorite}
                  className="rounded-full"
                >
                  <Heart className={`w-5 h-5 ${isFavorite ? "fill-primary text-primary" : ""}`} />
                </Button>
                <Button
                  variant="outline"
                  size="icon"
                  onClick={handleShare}
                  className="rounded-full"
                >
                  <Share2 className="w-5 h-5" />
                </Button>
              </div>
            </div>

            {/* Gallery */}
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
            >
              <PropertyGallery 
                images={property.images || []} 
                title={property.title} 
              />
            </motion.div>

            {/* Content Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
              {/* Main Content */}
              <div className="lg:col-span-2 space-y-8">
                {/* Header */}
                <motion.div
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.1 }}
                >
                  <div className="flex flex-wrap gap-2 mb-3">
                    <span className="px-3 py-1 rounded-full text-xs font-medium bg-primary/10 text-primary">
                      {getListingTypeLabel(property.listing_type)}
                    </span>
                    <span className="px-3 py-1 rounded-full text-xs font-medium bg-secondary text-secondary-foreground">
                      {getPropertyTypeLabel(property.property_type)}
                    </span>
                    {property.is_verified && (
                      <span className="px-3 py-1 rounded-full text-xs font-medium bg-accent/10 text-accent flex items-center gap-1">
                        <Check className="w-3 h-3" />
                        Vérifié
                      </span>
                    )}
                  </div>

                  <h1 className="text-2xl sm:text-3xl font-bold text-foreground mb-2">
                    {property.title}
                  </h1>

                  <div className="flex items-center gap-2 text-muted-foreground">
                    <MapPin className="w-4 h-4" />
                    <span>{property.neighborhood ? `${property.neighborhood}, ` : ""}{property.city}</span>
                  </div>

                  {/* Quick Stats */}
                  <div className="flex flex-wrap gap-6 mt-4 pt-4 border-t border-border">
                    {property.bedrooms && (
                      <div className="flex items-center gap-2">
                        <Bed className="w-5 h-5 text-muted-foreground" />
                        <span className="font-medium">{property.bedrooms}</span>
                        <span className="text-muted-foreground">chambre{property.bedrooms > 1 ? "s" : ""}</span>
                      </div>
                    )}
                    {property.bathrooms && (
                      <div className="flex items-center gap-2">
                        <Bath className="w-5 h-5 text-muted-foreground" />
                        <span className="font-medium">{property.bathrooms}</span>
                        <span className="text-muted-foreground">sdb</span>
                      </div>
                    )}
                    {property.area && (
                      <div className="flex items-center gap-2">
                        <Square className="w-5 h-5 text-muted-foreground" />
                        <span className="font-medium">{property.area}</span>
                        <span className="text-muted-foreground">m²</span>
                      </div>
                    )}
                  </div>
                </motion.div>

                {/* Description */}
                <motion.div
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.2 }}
                  className="space-y-4"
                >
                  <h2 className="text-lg font-semibold text-foreground">Description</h2>
                  <div className="prose prose-sm max-w-none text-muted-foreground whitespace-pre-line">
                    {property.description}
                  </div>
                </motion.div>

                {/* Amenities */}
                {property.amenities && property.amenities.length > 0 && (
                  <motion.div
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.3 }}
                  >
                    <PropertyAmenities amenities={property.amenities} />
                  </motion.div>
                )}

                {/* Rules */}
                {property.rules && property.rules.length > 0 && (
                  <motion.div
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: 0.35 }}
                    className="space-y-4"
                  >
                    <h3 className="text-lg font-semibold text-foreground">Règles du logement</h3>
                    <div className="flex flex-wrap gap-2">
                      {property.rules.map((rule, i) => (
                        <span
                          key={i}
                          className="px-3 py-2 rounded-lg bg-secondary text-secondary-foreground text-sm"
                        >
                          {rule}
                        </span>
                      ))}
                    </div>
                  </motion.div>
                )}

                {/* Map */}
                <motion.div
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.4 }}
                >
                  <PropertyMap
                    latitude={property.latitude || undefined}
                    longitude={property.longitude || undefined}
                    address={property.address || undefined}
                    city={property.city}
                    neighborhood={property.neighborhood || undefined}
                  />
                </motion.div>
              </div>

              {/* Sidebar */}
              <div className="space-y-6">
                {/* Price Card */}
                <motion.div
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.15 }}
                  className="sticky top-24 space-y-6"
                >
                  <div className="rounded-2xl border border-border bg-card p-6">
                    <div className="mb-4">
                      <span className="text-3xl font-bold text-foreground">
                        {property.price.toLocaleString('fr-FR')} FCFA
                      </span>
                      <span className="text-muted-foreground">
                        /{getPriceUnitLabel(property.price_unit)}
                      </span>
                    </div>

                    {property.deposit && (
                      <div className="flex items-center justify-between py-2 border-t border-border">
                        <span className="text-muted-foreground">{t("property.deposit")}</span>
                        <span className="font-medium">{property.deposit.toLocaleString('fr-FR')} FCFA</span>
                      </div>
                    )}

                    {property.min_stay_days && (
                      <div className="flex items-center justify-between py-2 border-t border-border">
                        <span className="text-muted-foreground">{t("property.minStay")}</span>
                        <span className="font-medium">{property.min_stay_days} {t("property.days")}</span>
                      </div>
                    )}

                    <BookingDialog
                      propertyId={property.id}
                      propertyTitle={property.title}
                      ownerId={property.owner_id}
                      ownerName={owner?.full_name || undefined}
                    >
                      <Button variant="hero" size="lg" className="w-full mt-4">
                        {t("property.reserveVisit")}
                      </Button>
                    </BookingDialog>
                    
                    {/* WhatsApp Button - Use whatsapp_number first, then phone */}
                    <WhatsAppButton
                      phoneNumber={owner?.whatsapp_number || owner?.phone || null}
                      propertyTitle={property.title}
                      className="w-full mt-2"
                    />
                  </div>

                  {/* Owner Card */}
                  <div className="rounded-2xl border border-border bg-card p-4">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 rounded-full bg-secondary flex items-center justify-center">
                        <User className="w-6 h-6 text-muted-foreground" />
                      </div>
                      <div className="flex-1">
                        <p className="font-medium text-foreground">
                          {owner?.full_name || "Propriétaire"}
                        </p>
                        <div className="flex items-center gap-2 text-sm">
                          {owner?.is_verified && (
                            <span className="flex items-center gap-1 text-accent">
                              <Shield className="w-3 h-3" />
                              Vérifié
                            </span>
                          )}
                          <span className="flex items-center gap-1 text-muted-foreground">
                            <Star className="w-3 h-3 fill-gold text-gold" />
                            4.8
                          </span>
                        </div>
                      </div>
                    </div>
                    
                    {/* Report Button */}
                    <ReportDialog 
                      propertyId={property.id} 
                      userId={property.owner_id}
                    />
                  </div>

                  {/* Calendar */}
                  <PropertyCalendar
                    availableFrom={property.available_from}
                    availableTo={property.available_to}
                    isAvailable={property.is_available}
                  />

                  {/* Contact Form */}
                  <PropertyContactForm
                    propertyId={property.id}
                    ownerName={owner?.full_name || undefined}
                  />
                </motion.div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </>
  );
};

export default PropertyDetail;
